#!/usr/bin/make -f
# -*- makefile -*-
# Sample debian/rules that uses debhelper.
# This file was originally written by Joey Hess and Craig Small.
# As a special exception, when this file is copied by dh-make into a
# dh-make output file, you may use that output file without restriction.
# This special exception was added by Craig Small in version 0.37 of dh-make.
#
# This version is for a hypothetical package that can build a kernel modules
# architecture-dependant package via make-kpkg, as well as an
# architecture-independent module source package, and other packages
# either dep/indep for things like common files or userspace components
# needed for the kernel modules.

# Uncomment this to turn on verbose mode.
#export DH_VERBOSE=1

pname:=mlnx-ofed-kernel
psource:=$(pname)-source
pdkms:=$(pname)-dkms
putils:=$(pname)-utils

pversion := $(shell dpkg-parsechangelog | sed -n 's/^Version: *\([^-]\+\)-.\+/\1/p')

export INSTALL_MOD_DIR:=updates
export INSTALL_MOD_PATH:=$(CURDIR)/debian/$(pname)

DIST_NAME := $(shell lsb_release -si)
DIST_RELEASE := $(DIST_NAME)/$(shell lsb_release -sc)
ifndef KVERS
	KVERS := $(shell uname -r)
endif

%:
	dh $@ --with dkms

override_dh_auto_clean:

override_dh_auto_configure:
#	@echo Building for $(DIST_RELEASE)
#	$(CURDIR)/configure $(shell $(CURDIR)/ofed_scripts/dkms_ofed $(KVERS) get-config)

override_dh_auto_build:
#	make kernel
override_dh_auto_test:

override_dh_auto_install:
	# INSTALL_MOD_PATH=$(INSTALL_MOD_PATH) INSTALL_MOD_DIR=$(INSTALL_MOD_DIR) dh_auto_install
	# For dkms
	dh_installdirs -p$(pdkms)  usr/src/$(pname)-$(pversion)
	cp -a compat*		debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	cp -a include		debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	cp -a drivers		debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	cp -a net		debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	cp -a fs		debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	cp -a backports		debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	cp -a ofed_scripts	debian/$(pdkms)/usr/src/$(pname)-$(pversion)
#	cp -a backports_applied	debian/$(pdkms)/usr/src/$(pname)-$(pversion)
	$(CURDIR)/ofed_scripts/generate_dkms_conf.sh > debian/$(pdkms)/usr/src/$(pname)-$(pversion)/dkms.conf
	cd debian/$(pdkms)/usr/src/$(pname)-$(pversion); ln -s ofed_scripts/configure
	cd debian/$(pdkms)/usr/src/$(pname)-$(pversion); ln -s ofed_scripts/makefile
	cd debian/$(pdkms)/usr/src/$(pname)-$(pversion); ln -s ofed_scripts/Makefile
	cd debian/$(pdkms)/usr/src; ln -s $(pname)-$(pversion) ofa_kernel
	# For utils
	dh_installdirs -p$(putils)  etc/infiniband
	dh_installdirs -p$(putils)  etc/modprobe.d
	dh_installdirs -p$(putils)  sbin
	dh_installdirs -p$(putils)  bin
	dh_installdirs -p$(putils)  usr/bin
	dh_installdirs -p$(putils)  usr/sbin
	dh_installdirs -p$(putils)  etc/udev/rules.d
	dh_installdirs -p$(putils)  etc/init.d
	dh_installdirs -p$(putils)  etc/init
	cp ofed_scripts/openib.conf debian/$(putils)/etc/infiniband
	# Prepare /etc/infiniband/info
	echo '#!/bin/bash'						> debian/$(putils)/etc/infiniband/info
	echo								>> debian/$(putils)/etc/infiniband/info
	echo 'echo prefix=/usr'						>> debian/$(putils)/etc/infiniband/info
	echo 'echo Kernel=`uname -r`'					>> debian/$(putils)/etc/infiniband/info
	echo 'echo'							>> debian/$(putils)/etc/infiniband/info
	echo 'echo "Configure options: `/usr/src/$(pname)-$(pversion)/ofed_scripts/dkms_ofed $(KVERS) get-config`"'	>> debian/$(putils)/etc/infiniband/info
	echo 'echo'							>> debian/$(putils)/etc/infiniband/info
	chmod 755 debian/$(putils)/etc/infiniband/info

	install -m 0755 ofed_scripts/sysctl_perf_tuning		debian/$(putils)/sbin
	install -m 0755 ofed_scripts/mlnx_tune			debian/$(putils)/usr/sbin
	install -m 0755 ofed_scripts/connectx_port_config	debian/$(putils)/sbin
	install -m 0755 ofed_scripts/ipoibd			debian/$(putils)/sbin
	install -m 0755 ofed_scripts/get-bond-master		debian/$(putils)/usr/sbin
	install -m 0755 ofed_scripts/*affinity*			debian/$(putils)/usr/sbin
	install -m 0755 ofed_scripts/ibdev2netdev		debian/$(putils)/usr/bin
	install -m 0755 ofed_scripts/mlnx-ofed-kernel-utils.openibd.upstart	debian/$(putils)/etc/init/openibd.conf
	install -m 0755 ofed_scripts/mlnx-ofed-kernel-utils.openibd.init	debian/$(putils)/etc/init.d/openibd
	install -m 0644 ofed_scripts/mlnx.conf			debian/$(putils)/etc/modprobe.d
#	install -m 0644 ofed_scripts/mlx4_en.conf		debian/$(putils)/etc/modprobe.d
	install -m 0644 ofed_scripts/ib_ipoib.conf		debian/$(putils)/etc/modprobe.d
	install -m 0644 ofed_scripts/90-ib.rules 		debian/$(putils)/etc/udev/rules.d
	install -m 0755 ofed_scripts/mlnx_interface_mgr_deb.sh	debian/$(putils)/bin/mlnx_interface_mgr.sh

	cd ofed_scripts/utils;	python ./setup.py install --prefix=/usr --root=../../debian/$(putils)

override_dh_installinit:
