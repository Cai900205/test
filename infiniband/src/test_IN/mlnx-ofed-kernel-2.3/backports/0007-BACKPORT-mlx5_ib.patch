From: Vladimir Sokolovsky <vlad@mellanox.com>
Subject: [PATCH] BACKPORT: mlx5_ib

Signed-off-by: Vladimir Sokolovsky <vlad@mellanox.com>
---
 drivers/infiniband/hw/mlx5/main.c |    7 +++++++
 drivers/infiniband/hw/mlx5/mr.c   |    4 +++-
 2 files changed, 10 insertions(+), 1 deletions(-)

diff --git a/drivers/infiniband/hw/mlx5/main.c b/drivers/infiniband/hw/mlx5/main.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/hw/mlx5/main.c
+++ b/drivers/infiniband/hw/mlx5/main.c
@@ -876,8 +876,10 @@ static unsigned long mlx5_ib_get_unmapped_area(struct file *file,
 					       unsigned long flags)
 {
 	struct mm_struct *mm;
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 11, 0))
 	struct vm_area_struct *vma;
 	unsigned long start_addr;
+#endif
 	unsigned long order;
 	unsigned long command;
 
@@ -895,6 +897,7 @@ static unsigned long mlx5_ib_get_unmapped_area(struct file *file,
 
 	order = get_pg_order(pgoff);
 
+#if (LINUX_VERSION_CODE < KERNEL_VERSION(3, 11, 0))
 	/*
 	 * code is based on the huge-pages get_unmapped_area code
 	 */
@@ -917,6 +920,10 @@ full_search:
 			return addr;
 		addr = ALIGN(vma->vm_end, 1 << order);
 	}
+#else
+	return current->mm->get_unmapped_area(file, addr, len,
+					      pgoff, flags);
+#endif
 }
 
 
diff --git a/drivers/infiniband/hw/mlx5/mr.c b/drivers/infiniband/hw/mlx5/mr.c
index xxxxxxx..xxxxxxx xxxxxx
--- a/drivers/infiniband/hw/mlx5/mr.c
+++ b/drivers/infiniband/hw/mlx5/mr.c
@@ -1596,7 +1596,9 @@ static int mlx5_ib_invalidate_mr(struct ib_mr *ibmr)
 	struct ib_umem *umem = mr->umem;
 	int npages = mr->npages;
 	int err;
-
+#if (LINUX_VERSION_CODE <= KERNEL_VERSION(2, 6, 16))
+	int cached = mr->cached;
+#endif
 #ifdef CONFIG_INFINIBAND_ON_DEMAND_PAGING
 	if (umem && umem->odp_data) {
 		/* Prevent new page faults from succeeding */
