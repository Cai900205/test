Content:
1. Overview
2. Directory structure
3. HOWTO add a new feature/fix
4. HOWTO add backport patches
5. Adding a feature based on Distro/kernel
6. Check compilation
7. Submitting to Gerrit
8. Email format


Overview:
---------
The general idea is based on compat-wireless project https://lkml.org/lkml/2011/9/9/327
Compat Wiki:
https://backports.wiki.kernel.org/index.php/Main_Page
https://backports.wiki.kernel.org/index.php/Documentation

Directory structure:
--------------------
MLNX_OFED-2.0 git tree structure:
Compat files:
	compat/
	include/linux/compat*h
	ofed_scripts/gen-compat-autoconf.sh
	ofed_scripts/gen-compat-config.sh

Backport patches:
	backports/

Kernel subtree based on kernel.org 3.7:
	include/
	drivers/
	net/
	Documentation/

Compilation procedure (same as before):
# cd mofed-linux-2.0
# git checkout mlnx_ofed_2_2
# ln -s ofed_scripts/configure
# ln -s ofed_scripts/makefile
# ln -s ofed_scripts/Makefile

# ./configure <params>
E.g.: ./configure --with-core-mod --with-user_mad-mod --with-user_access-mod --with-addr_trans-mod --with-mlx4-mod --with-mlx4_en-mod --with-ipoib-mod --with-srp-mod --with-rds-mod --with-iser-mod

Note: If "backports_applied" file exist then backport patches will not be applied.

# make
# make install

HOWTO add a new feature/fix:
----------------------------
Start with updated branch (equal to “mlnx_ofed_2_2”).
Add the new code.
Check compilation on the kernel base (3.7).
# ./configure <params> --without-backport-patches
# make
# make install
Check your feature.
Commit the changes.
Then add backports if required.
See "Check compilation"

Note: Make sure your commits pass linux-2.6/scripts/checkpatch.pl
      Backport patches may not pass this check


HOWTO add backport patches:
---------------------------
Start with updated branch (equal to “mlnx_ofed_next”)

!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
!!! NOTE: BACKPORT PATCHES MAY CHANGE FILES UNDER FOLLOWING DIRECTORIES                                               !!!
!!!			include/rdma/                                                                                 !!!
!!!			include/linux/mlx4/                                                                           !!!
!!!			include/linux/mlx5/                                                                           !!!
!!!			drivers/                                                                                      !!!
!!!			net/                                                                                          !!!
!!!			AND SHOULD NOT TOUCH FILES UNDER ofed_scripts, compat and compat headers under include/linux/ !!!
!!! CHANGES TO THE FILES UNDER ofed_scripts, compat and include/linux/compat*.h SHOULD BE COMMITTED DIRECTLY          !!!
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

$ ln -s ofed_scripts/configure
$ ln -s ofed_scripts/makefile
$ ln -s ofed_scripts/Makefile
$ /bin/rm -f backports_applied
Run configure (check parameters)
$ ./configure --with-core-mod --with-user_mad-mod --with-user_access-mod --with-addr_trans-mod --with-mlx4-mod --with-mlx4_en-mod --with-ipoib-mod --with-srp-mod --with-rds-mod --with-iser-mod

The new branch will be created: “backport-backports”
All backports are applied.

$ make KBUILD_NOCMDDEP=1 2>&1 | tee log

In case of undefined variable/function refer to:
https://backports.wiki.kernel.org/index.php/Documentation/compat

If some functionality was backported to some supported Distro need to add CONFIG_COMPAT_... flag:
For example, "netdev_get_prio_tc_map" was added in 2.6.39 but backported to RHEL6.[23]
ifeq ($(RHEL_MAJOR),6)
 CFLAGS += -DCONFIG_COMPAT_IS_PRIO_TC_MAP
 ...
endif

diff --git a/drivers/infiniband/core/cma.c b/drivers/infiniband/core/cma.c
index 0bf5a9d..f0f75b6 100644
--- a/drivers/infiniband/core/cma.c
+++ b/drivers/infiniband/core/cma.c
@@ -1844,10 +1844,14 @@ static int cma_resolve_iboe_route(struct rdma_id_private *id_priv)
        route->path_rec->reversible = 1;
        route->path_rec->pkey = cpu_to_be16(0xffff);
        route->path_rec->mtu_selector = IB_SA_EQ;
+#if (LINUX_VERSION_CODE >= KERNEL_VERSION(2,6,39)) || defined(CONFIG_COMPAT_IS_PRIO_TC_MAP)
        route->path_rec->sl = netdev_get_prio_tc_map(
                        ndev->priv_flags & IFF_802_1Q_VLAN ?
                                vlan_dev_real_dev(ndev) : ndev,
                        rt_tos2priority(id_priv->tos));
+#else
+       route->path_rec->sl = id_priv->tos >> 5;
+#endif

Create a new backport patch from the diff above:
1. Commit the change (add commit BACKPORT: ...)
2. Get updated/new patches:
$ ./ofed_scripts/ofed_format_patch.sh mlnx_ofed_next..
Change branch to the original (E.g. “mlnx_ofed_next”)
Update/add new relevant patches under "backports" directory
$ cp -a ./backports_new/0XXX-<new patch>.patch backports
$ git add backports
$ git commit -s -m”BACKPORTS: Added RHEL6.[23] support” backports/

Adding a feature based on Distro/kernel:
----------------------------------------
E.g. Adding LRO to kernels <= 3.2
Add to ofed_scripts/gen-compat-config.sh

if [[ ${CONFIG_COMPAT_KERNEL_3_2} = "y" ]]; then
...
	set_config CONFIG_COMPAT_USE_LRO y
...
fi

Edit drivers/infiniband/ulp/ipoib/ipoib.h
#ifdef CONFIG_COMPAT_USE_LRO
#include <linux/inet_lro.h>
#endif
…
#ifdef CONFIG_COMPAT_USE_LRO
… LRO code…
#else
… original GRO code …
#endif
…

Run make to compile
make install
openibd restart

Create a new backport patch from the diff above:
1. Commit the change (add commit BACKPORT: ...)
2. Get updated/new patches:
$ mkdir -p /tmp/backports/
$ rm -f /tmp/backports/*
$ git format-patch --no-numbered -o /tmp/backports/ mlnx_ofed_next..
Change branch to the original (E.g. “mlnx_ofed_next”)
Update/add new relevant patches under "backports" directory
$ cp -a /tmp/backports/0XXX-<new patch>.patch backports
$ git add backports
$ git commit -s -m”BACKPORTS: Added LRO support” backports/

Check compilation:
------------------
Use your user and not "root".
$ cd /mswg/projects/art
$ git_url=<git url> git_branch=<git branch> ./build mofed_kernel

Submitting to Gerrit:
---------------------
Please refer to
http://wiki.lab.mtl.com/tiki/tiki-index.php?page=Code+Review&structure=OFED-LE#Gerrit

Send email to vlad@mellanox.com.

Email format:
-------------

Git URL:
Git Branch:

Changelog:

Compilation Summary:
